function Get-RDMDisk
{
    [CmdletBinding()]
    param (
        [Parameter(Mandatory = $true,
        ParameterSetName     = 'VMName')]
        [System.String[]] 
        $VMName,

        [Parameter(Mandatory = $true,
        ValueFromPipeline    = $true,
        ParameterSetName     = 'VMObject')]
        [VMware.VimAutomation.ViCore.Types.V1.Inventory.VirtualMachine[]]
        $VM,

        [System.String] 
        $ReportPath
    )

    begin
    {
        Write-Verbose "$(Get-Date) Get-RDMDisk    Started execution"
        
        [System.Collections.ArrayList]$alReport = [System.Collections.ArrayList]::New()
        [System.Array]$vmList                   = @()
        [System.String]$strRoundRobin           = 'Round Robin'
        [System.String]$strMRU                  = 'Most Recently Used'
    }

    process
    {
        switch ($PSCmdlet.ParameterSetName)
        {
            'VMName'   {$vmList = $VMName}
            'VMObject' {$vmList = $VM}
        }

        Write-Debug "$(Get-Date) Get-RDMDisk    ParameterSetName - $($PSCmdlet.ParameterSetName)"
        
        foreach ($vmItem in $vmList)
        {
            [System.String]$projectName = ''
            
            switch ($vmItem.GetType().Name)
            {
                'VirtualMachineImpl' {$vmView = Get-View -ViewType VirtualMachine -Filter @{"Name" = $vmItem.Name}}
                'String'             {$vmView = Get-View -ViewType VirtualMachine -Filter @{"Name" = $vmItem}}
            }

            Write-Verbose "$(Get-Date) Get-RDMDisk    Started collect data about VM $($vmView.Name)"
            
            $hostView       = Get-View -Id $vmView.Runtime.Host
            $clusterView    = Get-View -Id $hostView.Parent
            $datacenterView = $clusterView
            do
            {
                $datacenterView = Get-View -Id $datacenterView.Parent
            }
            while ($datacenterView.MoRef.Type -ne 'Datacenter' -and $datacenterView)

            $hostLun = $hostView.Config.StorageDevice.ScsiLun
            $hostMP  = $hostView.Config.StorageDevice.MultipathInfo.Lun
            
            $hddList = $vmView.Config.Hardware.Device | Where-Object {$_.Backing -match 'DiskRaw'}
            $osName  = $vmView.Config.GuestFullName

            $projectKey  = ($vmView.AvailableField | Where-Object {$_.Name -like 'ProjectName'}).Key
            $projectName = ($vmView.Summary.CustomValue | Where-Object {$_.Key -like $projectKey}).Value
            
            if (!($projectName))
            {
                $projectName = $datacenterView.Name
            }

            if ($hddList.Count -eq 0)
            {
                Write-Verbose "$(Get-Date) Get-RDMDisk    VM $($vmView.Name) has no RDM disks"
            }
            else
            {
                foreach ($hdd in $hddList)
                {                    
                    Write-Verbose "$(Get-Date) Get-RDMDisk    Started collect data about RDM disk $($hdd.DeviceInfo.Label) on VM $($vmView.Name)"
                    
                    $lun            = $hostLun | Where-Object {$_.Uuid -like $hdd.Backing.DeviceName.Replace('vml.', '')}
                    $lunID          = ($hostMP | Where-Object {$_.Lun -eq $lun.Key}).Path[0].Name.Split(',')[0].Split(':')[-1].Replace('L','')
                    $lunMPShortName = ($hostMP | Where-Object {$_.Lun -eq $lun.Key}).Policy.Policy.Split('_')[-1]
                    
                    switch ($lunMPShortName)
                    {
                        'RR' {$lunMPFullName = $strRoundRobin}
                        'MRU'{$lunMPFullName = $strMRU}
                    }
                    
                    $fileName           = $hdd.Backing.FileName.Split(' ')[-1]
                    $datastoreName      = $hdd.Backing.FileName.Split(' ')[0].Replace('[','').Replace(']','')
                    $scsiControllerKey  = $hdd.ControllerKey
                    $scsiControllerView = $vmView.Config.Hardware.Device | Where-Object {$_.Key -like $scsiControllerKey}

                    $htReport = [PSCustomObject][Ordered]@{VM_NAME              = $vmView.Name
                                                           HOST_NAME            = $hostView.Name
                                                           CLUSTER_NAME         = $clusterView.Name
                                                           DATACENTER_NAME      = $datacenterView.Name
                                                           PROJECT              = $projectName
                                                           OS                   = $osName
                                                           SCSI_CONTROLLER_NAME = $scsiControllerView.DeviceInfo.Label
                                                           HDD_UNIT_NUMBER      = $hdd.UnitNumber
                                                           CANONICAL_NAME       = $lun.CanonicalName                                                     
                                                           LUN_ID               = $lunID
                                                           LUN_VENDOR           = $lun.Vendor
                                                           LUN_MODEL            = $lun.Model
                                                           MP_POLICY            = $lunMPFullName
                                                           HDD_CAPACITY_GB      = [System.Math]::Round($hdd.CapacityInKB / 1MB, 2)
                                                           HDD_TYPE             = $hdd.Backing.CompatibilityMode.Replace('Mode','')
                                                           HDD_NAME             = $hdd.DeviceInfo.Label
                                                           DATASTORE_NAME       = $datastoreName
                                                           FILE_NAME            = $fileName
                                                           STORAGE_DEVICE_NAME  = $lun.DisplayName}
                    $alReport.Add($htReport) | Out-Null

                    Write-Verbose "$(Get-Date) Get-RDMDisk    Finished collect data about RDM disk $($hdd.DeviceInfo.Label) on VM $($vmView.Name)"
                }

                Write-Verbose "$(Get-Date) Get-RDMDisk    Finished collect data about VM $($vmView.Name)"                    
            }
        }

        if ($PSBoundParameters.ContainsKey('ReportPath') -and ($alReport.Count -ne 0))
        {
            try
            {
                Write-Verbose "$(Get-Date) Get-RDMDisk    Started export to file $ReportPath"

                $alReport | Export-Csv -Path $ReportPath -NoTypeInformation -Encoding UTF8 -Delimiter ';'

                Write-Verbose "$(Get-Date) Get-RDMDisk    Finished export to file $ReportPath"
            }
            catch
            {
                Write-Verbose "$(Get-Date) Get-RDMDisk    Failed export to file $ReportPath"

                Write-Warning $Error[0].FullyQualifiedErrorId
            }        
        }
        else
        {
            Write-Verbose "$(Get-Date) Get-RDMDisk    There are no RDM disks on the input VMs. Generating the report is skiping"
        }           
        
        $alReport
    }

    end
    {
        Write-Verbose "$(Get-Date) Get-RDMDisk    Finished execution"

        $alReport.Clear()
    }
}
